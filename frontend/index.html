<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<title>í•™ì› ê´€ë¦¬ì í…ŒìŠ¤íŠ¸ í˜ì´ì§€</title>

<style>
body {
    font-family: Arial, sans-serif;
    margin: 20px;
}
.container {
    display: flex;
    gap: 30px;
}
.panel {
    width: 33%;
    border-right: 1px solid #ddd;
    padding-right: 15px;
}
.panel:last-child {
    border-right: none;
}
input, textarea, select, button {
    width: 100%;
    margin-bottom: 6px;
    padding: 6px;
}
ul {
    list-style: none;
    padding: 0;
}
li {
    padding: 6px;
    cursor: pointer;
}
li:hover {
    background: #f0f0f0;
}
.selected {
    background: #dbeafe;
}
.status-present { color: green; }
.status-absent { color: red; }
.status-unchecked { color: gray; }

/* ===== ê³µìœ  ëª¨ë‹¬ ===== */
.modal {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.6);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 9999;
}

.hidden {
    display: none;
}

.modal-content {
    background: white;
    padding: 20px;
    border-radius: 10px;
    width: 420px;
    max-height: 90vh;
    overflow-y: auto;
    text-align: center;
    position: relative;
}

.modal-content h3 {
    margin-top: 0;
}

.close {
    position: absolute;
    right: 12px;
    top: 8px;
    cursor: pointer;
    font-size: 22px;
}

.share-image {
    width: 100%;
    border: 1px solid #ddd;
    border-radius: 6px;
    margin: 10px 0;
}

.hint {
    font-size: 13px;
    color: #666;
    margin-top: 8px;
}
</style>
</head>

<body>

<h1>ğŸ“‹ ê´€ë¦¬ì í†µí•© í…ŒìŠ¤íŠ¸ í˜ì´ì§€</h1>

<div class="container">

<!-- =========================
     í•™ìƒ ê´€ë¦¬
     ========================= -->
<div class="panel">
<h3>ğŸ‘©â€ğŸ“ í•™ìƒ ê´€ë¦¬</h3>

<input id="studentName" placeholder="ì´ë¦„" />
<input id="studentGrade" placeholder="í•™ë…„ (ì˜ˆ: ì¤‘2)" />
<button onclick="createStudent()">í•™ìƒ ë“±ë¡</button>

<hr />
<ul id="studentList"></ul>
</div>

<!-- =========================
     ì¶œì„ ê´€ë¦¬
     ========================= -->
<div class="panel">
<h3>ğŸ•’ ì¶œì„ ê´€ë¦¬ (ì˜¤ëŠ˜)</h3>

<p id="attendanceStudentText">í•™ìƒ ì„ íƒ í•„ìš”</p>

<select id="attendanceStatus">
    <option value="present">ì¶œì„</option>
    <option value="absent">ê²°ì„</option>
</select>

<input id="checkIn" type="time" />
<input id="checkOut" type="time" />

<button onclick="submitAttendance()">ì¶œì„ ì €ì¥</button>

<hr />
<h4>ğŸ“Š ì˜¤ëŠ˜ ì¶œì„ í˜„í™©</h4>
<ul id="attendanceList"></ul>
</div>

<!-- =========================
     ì¼ì§€ ê´€ë¦¬
     ========================= -->
<div class="panel">
<h3>ğŸ“˜ ì¼ì§€ ê´€ë¦¬</h3>

<p id="logStudentText">í•™ìƒ ì„ íƒ í•„ìš”</p>

<input id="logDate" type="date" />
<textarea id="tasksInput" placeholder="í•  ì¼ (í•œ ì¤„ì— í•˜ë‚˜)"></textarea>
<textarea id="teacherNote" placeholder="ì„ ìƒë‹˜ ë©”ëª¨"></textarea>

<button onclick="createDailyLog()">ì¼ì§€ ì €ì¥</button>

<hr />
<ul id="logList"></ul>
</div>

<!-- =========================
     ìš”ì¼ë³„ ë“±ì› ì‹œê°„ ê´€ë¦¬
     ========================= -->
<div class="panel">
<h3>ğŸ“… ìš”ì¼ë³„ ë“±ì› ì‹œê°„</h3>
<ul id="scheduleList"></ul>
</div>


<!-- =========================
     ë¯¸ì¶œì„ í•™ìƒ ê´€ë¦¬
     ========================= -->
<div class="panel">
<h3>ğŸš¨ ì•„ì§ ì•ˆ ì˜¨ í•™ìƒ</h3>

<button onclick="loadAbsentStudents()">ìƒˆë¡œê³ ì¹¨</button>
<button onclick="sendSelectedSMS()">ì„ íƒ ë¬¸ì ë°œì†¡</button>

<hr />
<ul id="absentList"></ul>
</div>




</div>

<script>
const API = "http://127.0.0.1:8000";
let selectedStudent = null;

const WEEKDAYS = [
  { value: 0, label: "ì›”" },
  { value: 1, label: "í™”" },
  { value: 2, label: "ìˆ˜" },
  { value: 3, label: "ëª©" },
  { value: 4, label: "ê¸ˆ" },
  { value: 5, label: "í† " },
  { value: 6, label: "ì¼" }
];

// =========================
// í•™ìƒ ëª©ë¡
// =========================
async function loadStudents() {
    const res = await fetch(`${API}/students/`);
    const students = await res.json();
    const list = document.getElementById("studentList");
    list.innerHTML = "";

    students.forEach(s => {
        const li = document.createElement("li");
        li.textContent = `${s.name} (${s.grade})`;
        li.onclick = () => selectStudent(s, li);
        list.appendChild(li);
    });
}

// =========================
// í•™ìƒ ì„ íƒ
// =========================
function selectStudent(student, li) {
    selectedStudent = student;

    document.querySelectorAll("li").forEach(x =>
        x.classList.remove("selected"));
    li.classList.add("selected");

    document.getElementById("attendanceStudentText")
        .textContent = `ì„ íƒ: ${student.name}`;
    document.getElementById("logStudentText")
        .textContent = `ì„ íƒ: ${student.name}`;

    loadAttendanceToday();
    loadDailyLogs();
    loadStudentSchedules();
}

// =========================
// í•™ìƒ ìƒì„±
// =========================
async function createStudent() {
    await fetch(`${API}/students/`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
            name: studentName.value,
            grade: studentGrade.value
        })
    });
    loadStudents();
}

// =========================
// ì¶œì„ ì €ì¥
// =========================
async function submitAttendance() {
    if (!selectedStudent) {
        return alert("í•™ìƒ ì„ íƒ");
    }

    // âœ… payload ë¨¼ì € ë§Œë“ ë‹¤
    const payload = {
        student_id: selectedStudent.id,
        date: new Date().toISOString().slice(0, 10),
        status: attendanceStatus.value,
        check_in: checkIn.value || null
    };

    // âœ… í‡´ì‹¤ ì‹œê°„ ì…ë ¥í–ˆì„ ë•Œë§Œ ì¶”ê°€
    if (checkOut.value) {
        payload.check_out = checkOut.value;
    }

    // âœ… fetchëŠ” í•œ ë²ˆë§Œ
    await fetch(`${API}/attendance/`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
    });

    await loadAttendanceToday();
}

// =========================
// ì˜¤ëŠ˜ ì¶œì„ í˜„í™©
// =========================
async function loadAttendanceToday() {
    const res = await fetch(`${API}/attendance/today`);
    const data = await res.json();
    const list = document.getElementById("attendanceList");
    list.innerHTML = "";

    data.students.forEach(s => {
        const li = document.createElement("li");
        li.innerHTML = `
            ${s.name} -
            <span class="status-${s.status}">
                ${s.status}
            </span>
        `;
        list.appendChild(li);
    });
}

// =========================
// ì¼ì§€ ìƒì„±
// =========================
async function createDailyLog() {
    if (!selectedStudent) return alert("í•™ìƒ ì„ íƒ");

    const tasks = tasksInput.value
        .split("\n")
        .map(t => t.trim())
        .filter(t => t !== "")
        .map(t => ({
            content: t,
        }));

    await fetch(`${API}/daily-logs/`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
            student_id: selectedStudent.id,
            date: logDate.value,
            tasks: tasks,
            teacher_note: teacherNote.value
        })
    });

    loadDailyLogs();
}


// =========================
// ì¼ì§€ ì¡°íšŒ
// =========================
async function loadDailyLogs() {
    const res = await fetch(
        `${API}/daily-logs/student/${selectedStudent.id}`
    );
    const logs = await res.json();
    const list = document.getElementById("logList");
    list.innerHTML = "";

    logs.forEach(log => {
        const li = document.createElement("li");

        const tasksHtml = log.tasks.map(t => `
            <li>
                <label>
                    <input
                        type="checkbox"
                        ${t.grading_done ? "checked" : ""}
                        onchange="updateTask(${t.id}, 'grading_done', this.checked)"
                    />
                    ì±„ì 
                </label>

                <label style="margin-left:10px;">
                    <input
                        type="checkbox"
                        ${t.review_done ? "checked" : ""}
                        onchange="updateTask(${t.id}, 'review_done', this.checked)"
                    />
                    ì˜¤ë‹µ
                </label>

                <strong style="margin-left:10px;">
                    ${t.is_done ? "âœ… ì™„ë£Œ" : ""}
                </strong>

                <br/>
                ${t.content}
            </li>
        `).join("");

        li.innerHTML = `
            <strong>${log.date}</strong>
            <ul>${tasksHtml}</ul>
            ë©”ëª¨: ${log.teacher_note || ""}

            <br/><br/>
            <button onclick="shareKakao(${log.id})">
              ğŸ“¤ í•™ë¶€ëª¨ì—ê²Œ ê³µìœ 
            </button>
        `;

        list.appendChild(li);
    });
}


async function updateTask(taskId, field, value) {
    await fetch(`${API}/daily-tasks/${taskId}`, {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
            [field]: value
        })
    });

    loadDailyLogs();
}

// =========================
// ë¯¸ì¶œì„ í•™ìƒ ì¡°íšŒ
// =========================
let absentStudents = [];

async function loadAbsentStudents() {
    const res = await fetch(`${API}/attendance/absent/today`);
    const data = await res.json();

    absentStudents = data;

    const list = document.getElementById("absentList");
    list.innerHTML = "";

    if (data.length === 0) {
        list.innerHTML = "<li>ğŸ‰ ëª¨ë‘ ì¶œì„ ì™„ë£Œ</li>";
        return;
    }

    data.forEach(s => {
        const li = document.createElement("li");
        li.innerHTML = `
            <label>
                <input type="checkbox" data-id="${s.student_id}" />
                ${s.name}
            </label>
        `;
        list.appendChild(li);
    });
}

function sendSelectedSMS() {
    const checked = document.querySelectorAll(
        "#absentList input[type=checkbox]:checked"
    );

    if (checked.length === 0) {
        alert("ì„ íƒëœ í•™ìƒì´ ì—†ìŠµë‹ˆë‹¤.");
        return;
    }

    const names = [];

    checked.forEach(cb => {
        const student = absentStudents.find(
            s => s.student_id == cb.dataset.id
        );
        if (student) {
            names.push(student.name);
            console.log(
                `[ë¬¸ì ë°œì†¡] ${student.name} í•™ë¶€ëª¨ì—ê²Œ ë¬¸ì ì „ì†¡`
            );
        }
    });

    alert(
        `ë¬¸ì ë°œì†¡ ì™„ë£Œ (ì„ì‹œ)\n\nëŒ€ìƒ:\n- ${names.join("\n- ")}`
    );
}

// =========================
// ìš”ì¼ë³„ ë“±ì› ì‹œê°„ ì €ì¥
// =========================S
async function loadStudentSchedules() {
    const res = await fetch(
        `${API}/students/${selectedStudent.id}/schedules/`
    );
    const schedules = await res.json();

    const map = {};
    schedules.forEach(s => {
        map[s.weekday] = s.expected_time;
    });

    const list = document.getElementById("scheduleList");
    list.innerHTML = "";

    WEEKDAYS.forEach(d => {
        const li = document.createElement("li");

        li.innerHTML = `
            <label>
                ${d.label}ìš”ì¼
                <input
                    type="time"
                    value="${map[d.value] || ""}"
                    onchange="saveSchedule(${d.value}, this.value)"
                />
            </label>
        `;

        list.appendChild(li);
    });
}


// ì €ì¥
async function saveSchedule(weekday, time) {
    if (!time || !selectedStudent) return;

    await fetch(
        `${API}/students/${selectedStudent.id}/schedules/`,
        {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
                weekday: weekday,
                expected_time: time
            })
        }
    );
}


let currentShareUrl = null;

async function shareKakao(logId) {
    // 1ï¸âƒ£ ìµœì‹  ì¼ì§€ ë‹¤ì‹œ ë¶ˆëŸ¬ì˜¤ê¸° (ì¤‘ìš”!!)
    await loadDailyLogs();

    // 2ï¸âƒ£ ì´ë¯¸ì§€ ìƒì„± ìš”ì²­
    const res = await fetch(
        `${API}/daily-logs/${logId}/image`,
        { method: "POST" }
    );
    const data = await res.json();

    // 3ï¸âƒ£ ì´ë¯¸ì§€ í‘œì‹œ
    const BASE = "https://autotoxic-dorathy-noncharitably.ngrok-free.dev";
    currentShareUrl = `${BASE}${data.image_url}?t=${Date.now()}`;

    document.getElementById("shareImage").src = currentShareUrl;
    document.getElementById("shareModal").classList.remove("hidden");
}


function closeShareModal() {
    document.getElementById("shareModal").classList.add("hidden");
}



async function copyImageToClipboard() {
    if (!currentShareUrl) {
        alert("ì´ë¯¸ì§€ê°€ ì—†ìŠµë‹ˆë‹¤.");
        return;
    }

    try {
        // 1ï¸âƒ£ ì´ë¯¸ì§€ fetch
        const res = await fetch(currentShareUrl);
        const blob = await res.blob();

        // 2ï¸âƒ£ ClipboardItem ìƒì„±
        const item = new ClipboardItem({
            [blob.type]: blob
        });

        // 3ï¸âƒ£ í´ë¦½ë³´ë“œì— ì´ë¯¸ì§€ ì“°ê¸°
        await navigator.clipboard.write([item]);

        alert("ğŸ–¼ï¸ ì´ë¯¸ì§€ê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!\nì¹´ì¹´ì˜¤í†¡ì— Ctrl+V í•˜ì„¸ìš”.");
    } catch (err) {
        console.error(err);
        alert(
            "ì´ë¯¸ì§€ ë³µì‚¬ ì‹¤íŒ¨ ğŸ˜¢\n\n" +
            "âš ï¸ í¬ë¡¬/ì—£ì§€ì—ì„œë§Œ ê°€ëŠ¥í•˜ê³ \n" +
            "âš ï¸ HTTPS(ngrok) í™˜ê²½ì´ì–´ì•¼ í•©ë‹ˆë‹¤."
        );
    }
}


// ì´ˆê¸° ì‹¤í–‰
loadStudents();
</script>


<!-- ğŸ“¤ í•™ë¶€ëª¨ ê³µìœ  ëª¨ë‹¬ -->
<div id="shareModal" class="modal hidden">
  <div class="modal-content">
    <span class="close" onclick="closeShareModal()">Ã—</span>

    <h3>ğŸ“¤ í•™ë¶€ëª¨ì—ê²Œ ë³´ë‚´ê¸°</h3>

    <img id="shareImage" class="share-image" />

    <p class="hint">
      ğŸ–±ï¸ ì´ë¯¸ì§€ì—ì„œ <b>ë§ˆìš°ìŠ¤ ì˜¤ë¥¸ìª½ í´ë¦­ â†’ â€œì´ë¯¸ì§€ ë³µì‚¬â€</b><br/>
    ì¹´ì¹´ì˜¤í†¡ ëŒ€í™”ì°½ì— ë°”ë¡œ ë¶™ì—¬ë„£ê¸° í•˜ì„¸ìš”
    </p>
  </div>
</div>

</body>
</html>